## 数据工程小工具

本系统旨在为数据工程中的数据提取、数据转换、数据载入（ETL）和数据治理、空间数据处理和分析工作提供一套自动化批量处理工具。

### 使用方法
安装依赖库 `pip install -r requirements.txt`

运行interface.py

#### 开箱即用
文件解压缩后进入：数据工程工具集 —> dist —> interface 文件夹，双击interface.exe文件，即可进入工具主界面（图1）：
![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/ebb453dc-699f-4ee7-9b24-78bc3bffff46)

图1

### 工具说明
一、采集高德地图坐标

1.背景

某些表格数据中只有单位地址，而没有单位的经纬度信息，需要根据单位地址去查找和获取所在经纬度，从而将其矢量化，如企业名录数据需要根据企业的地址或名称获取其经纬度，数据总共有十几万条记录，靠人工一个个去查找显然不可能，因此需要使用批量处理的方法。

2.原理

高德地图提供了地理/逆地理编码的应用程序接口（API）服务，开发者可以通过调用该API，由单位的地址获取其经纬度坐标。在高德开放平台（https://lbs.amap.com/）注册账号并申请key后即可调用该服务。

本工具采用python代码编写，利用pandas库读取表格中的地址数据，利用requests库调用高德API获取POI数据，json库解析POI数据获取经纬度数据，for循环批量获取，获取到的数据用pandas库写入表格。

3.使用方法

点击工具主界面的“数据提取”->“采集高德地图坐标”，即可打开工具界面（图2）。

①　点击“选择”按钮，选择需要获取经纬度坐标的Excel表格文件路径。
②　输入高德开发平台的key。
③　点击“获取列名”按钮，获取输入表格的列名。
④　选择所在城市（可以限定城市范围，提高获取到的经纬度数据的准确性）和单位地址的列名。
⑤　点击“开始采集POI”按钮，开始获取经纬度数据（图3）。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/d6079cd1-69d6-4f37-8093-2ab57858f172)

图2

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/3c73530f-fb4b-4642-8ae7-ed75de95da45)

图3

数据采集完毕后会自动保存在输入表格的文件目录下，以“原文件名_output.xlsx”命名，在原数据中增加“高德坐标”字段（图4）。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/6e4331d7-1b18-4baf-84a7-48665f9ef2f9)

图4

4.注意事项

每个高德开放平台开发者账号获取POI的数量上限是每日5000个，一般获取到3000个左右就会有较多数据缺失，如果每天需要获取的数据量超过3000个，需要有多个高德开放平台开发者账号申请的key，或者在平台购买配额。

二、坐标转换工具

1.背景

由于国家的规定，国内的电子地图厂商需要对经纬度数据进行加密处理，如高德地图采用的是火星坐标系（GCJ-02），百度地图采用的是百度坐标系（BD-09），所以经常需要对电子地图获取到的经纬度数据进行坐标系转换，例如由火星坐标系转WGS84坐标系。

2.原理

不同坐标系之间相互转换的算法代码来自CSDN博客（https://blog.csdn.net/chenxu0136/article/details/119361975?spm=1001.2014.3001.5502），经过与GeoSharp工具的转换结果对比，代码转换结果与GeoSharp转换结果一致。

3.使用方法

点击工具主界面的“数据转换”->“坐标转换工具”，即可打开工具界面（图5）。

①　点击“选择”按钮，选择需要转换坐标系的Excel表格文件。
②　点击“选择”按钮，选择保存转换后坐标的Excel表格文件。
③　点击下拉框按钮，选择坐标转换方法。
④　点击“开始转换”按钮，转换后的坐标数据保存在“输出表格路径”中。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/0b616c0d-745d-4142-9e3d-cfccfaba5f08)

图5

4.注意事项

该算法代码转换后的坐标仍有3~10米左右的误差，如对数据的精度有较高要求，可到其他采用WGS84坐标系的电子地图获取经纬度坐标，如谷歌地图、OpenStreetMap等。
输入表格的经度字段名需为X，纬度字段名需为Y。

三、批量提取和汇总表格

1.背景

有些表格数据不是一行数据对应一条记录的结构化二维表格格式（如图6所示），需要提取表格中的记录数据，汇总成图7所示的结构化表格形式（一个图6表格记录对应图7表格的一行数据），再将其矢量化。当相同结构的记录表格较多时，可以采用批量方法提取和汇总数据。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/9e3de082-413d-447d-bf0b-a936e32b7baf)

图6

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/31869c50-bdae-489c-9c3e-a7109b71dd5e)

图7

2.原理

利用Python的xlwings库可以获取Excel表格中指定位置单元格的数据，再对获取到的字符串或数值数据进行处理，如提取冒号、逗号、空格等分隔符前后的数据。将所有相同结构的记录表格放在同一文件夹中，利用python的os库获取文件夹中所有文件名，循环读取和汇总每个记录表格的数据，最后写入汇总表格。

3.使用方法

点击工具主界面的“数据匹配”->“批量提取和汇总表格”，即可打开工具界面（图8）。

①　点击“选择”按钮，选择需要转化的Excel表格文件夹。
②　点击“选择”按钮，选择需要表格转化的对应关系表，如图9所示，在“单元格位置”列按顺序填写需要提取数据的单元格位置（如A1，B2，C3），在“数据操作”列填写需要对该单元格数据进行的数据处理方法编号（目前有6种方法，后续可以根据需求再增加）。
③　点击“选择”按钮，选择输出的Excel表格文件路径。
④　点击“开始转化”按钮，转化后的数据保存在“输出文件”路径下。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/072bdaba-f198-4718-bf41-e140618bcc46)

图8

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/680227cd-100b-448f-a898-eac47d075ec2)

图9

4.注意事项

表格转化前需要新建一个只有列名的空白汇总表格，如图10，并在“输出文件”中选择此表格文件路径。在“对应关系表”中，“单元格位置”列的输入顺序（从上到下）需要与输出汇总表格的列名顺序（从左到右）对应。“数据操作”列只能填写1-6的数字。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/3abb68c4-e187-4cae-8eea-51a8e4d9d393)

图10

四、批量提取PDF表格

1.背景

在数据治理过程中，用户提供的原始数据往往是PDF格式，需要从中提取出表格和对应的表名，虽然市面上有提取PDF文本和表格的软件，但大多要收费，且对不规则表格，如三线表（图11）的识别效果不佳，当PDF文件中有较多的表格时，难以实现批量提取。因此，根据工作中的需求，开发了可以批量提取PDF文件中表格和表名，并可以通过自定义表格提取参数，实现对不规则表格提取的小工具。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/34124ee1-2a44-4946-847b-43f64ef52fb4)

图11

2.原理

pdfplumber是一个功能强大、灵活的Python第三方库，可以识别和提取PDF文件中表格和文本，通过设置参数，可以实现对PDF文件中不同页面、页面位置、不同形式的表格和文本的提取。

3.使用方法

点击工具主界面的“数据提取”->“批量提取PDF表格”，即可打开工具界面（图12）。

①　点击“选择pdf”按钮，选择需要提取表格的PDF文件。
②　点击“选择保存文件夹路径”按钮，选择需要保存表格的文件夹路径。
③　点击“提取方法”下拉框，选择提取PDF表格的方法，目前有“提取单个页面的表格”、“提取全部表格到一个Excel”、“提取全部表格多个Excel”和“自定义”四种方法。
④　输入表格与表头的偏移距离，该参数是为了提取表格的表名，偏移距离是指表格的上边框到表名之间的距离（如图13所示），工具中默认设置为50，可以根据实际的PDF表格格式修改，如有些表格表头位于页面顶端，如果将偏移距离设置得过大，会超过页面的高度，造成报错。
⑤　点击“开始提取”按钮，如果提取成功，会出现“提取表格成功”提示框，如果提取失败，会出现报错信息（图14）。

3.1提取方法说明

3.1.1提取单个页面的表格

该方法是提取PDF文件中单个页面中的表格，需要输入PDF文件中表格所在页面的页码，页码可通过PDF阅读器查看，提取后的表格会以xlsx格式保存在②选择的文件夹路径下，以表名作为文件名。

3.1.2提取全部表格到一个Excel

该方法是提取PDF文件中所有页面中的表格到同一个Excel工作簿中，提取后的表格会以xlsx格式保存在②选择的文件夹路径下，以“输出表格”作为文件名。

3.1.3提取全部表格到多个Excel

该方法是提取PDF文件中所有页面中的表格到多个Excel工作簿中（一个工作簿保存一个表格），提取后的表格会以xlsx格式保存在②选择的文件夹路径下，以表名作为文件名。

3.1.4自定义

该方法是为了提取不规则的表格，如三线表，通过输入页码，指定想要提取的表格所在的PDF页面，通过输入“表格所在页面高度1”和“表格所在页面高度2”，指定表格所在的页面位置，如表格位于页面的1/4到3/4高度范围内，可设置“表格所在页面高度1”为0.25，设置“表格所在页面高度2”为0.75，通过输入自定义参数，指定具体的表格识别和提取方式，具体参数含义和参数值见pdfplumber文档（https://github.com/hbh112233abc/pdfplumber/blob/stable/README-CN.md），自定义参数输入完成后将光标放到文本的开头位置，再点击“开始提取”按钮。提取后的表格会以xlsx格式保存在②选择的文件夹路径下，以“输出表格”作为文件名。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/38cd4c8c-fb99-4336-8177-565b20c44c95)

图12

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/e39308a5-46b7-4951-90b0-bf03323fd76a)

图13

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/b62b1181-270a-47d0-926f-68a0e15dbd8e)
![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/50904cc2-1a93-40ba-91bd-4f8aec76ddf5)

图14

4.注意事项

本工具只能识别和提取文本格式的PDF表格，对于图片格式的PDF文件无法识别和提取，对规范格式的表格（有横平竖直、封闭的边框）的提取效果较好，对于不规范的表格提取后还需要手动调整和补充。

五、批量翻译字段名称

1.背景

在数据治理过程中，常常需要将数据的属性表格的字段名称翻译为英文（单词字母大写，以下划线连接，长度不超过要求），将别名改为中文的规范格式，当数据较多，表格的字段名称比较生僻时，手动去翻译和替换字段名称一件繁琐的事情，而且容易出错。因此，根据工作需要，开发了可以批量翻译字段名称，并转为规范格式的小工具。

2.原理

通过百度翻译开放平台（https://api.fanyi.baidu.com/api/trans/product/apidoc）提供的API接口，利用python的pandas库实现字段名的读取和写入，requests库发送请求和接收返回数据，可实现字段名的批量翻译，翻译结果通过字符串处理转为规范格式，并计算字符串长度，按照字符串长度排序输出翻译结果到Excel表格中。

3.使用方法

点击工具主界面的“数据匹配”->“批量翻译字段名称”，即可打开工具界面（图15）。

①　点击“选择”按钮，选择需要翻译的字段名表格文件，如图16所示，字段名填写在表格文件的第一列中（字段名可通过ArcPy脚本批量导出成CSV文件，见ArcPy脚本文档）。
②　点击“选择”按钮，选择保存翻译结果的表格文件。
③　点击“开始翻译字段”按钮，翻译结果会实时显示（图17），翻译完成后结果自动保存在表格文件中（图18）。

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/ff4a2537-05f4-4610-afb0-53d3909031ef)

图15

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/a9e7a456-5e66-4ca7-952e-8bcbd5bd47be)

图16

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/9c9d785b-013c-4233-be91-ebfa64cd8a38)

图17

![image](https://github.com/xf-huang/batch_data_processing_kits/assets/54733565/f4564f3f-8c22-4812-9cb9-16ca6cec2ed5)

图18

4.注意事项

本工具只能翻译和规范字段，不能自动缩写字段，对于超过规定长度的翻译结果，还需要手动进行缩写。

appid和appkey在代码中已经有默认设置，工具界面中的输入框可以不填，也可以在百度翻译开放平台注册获取appid和appkey。

本工具也可用于翻译表名，翻译后的字段名和表名可通过ArcPy脚本批量替换到原来的表格中，完成表名和字段名的批量翻译（见ArcPy脚本文档）。
